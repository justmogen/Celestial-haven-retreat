name: Deploy to local Ubuntu Server

on:
    push:
        branches:
            - master

jobs:

    build:
        name: Build my Next.js app
        runs-on: ubuntu-latest

        steps:
            -   name: Checkout code
                uses: actions/checkout@v3

            -   name: Set up Node.js
                uses: actions/setup-node@v3
                with:
                    node-version: 18
            -   name: Install dependencies
                run: npm ci

            -   name: Build
                run: npm run build

            -   name: Upload artifact
                uses: actions/upload-artifact@v3
                with:
                    name: build
                    path: .next

    deploy:
        name: Deploy to Ubuntu Server
        runs-on: ubuntu-latest
        needs: build

        steps:
            -   name: Download artifact
                uses: actions/download-artifact@v3
                with:
                    name: hotel-management
                    

            -   name: Deploy to Server
                env:
                    HOST: ${{ secrets.HOST }}
                    USERNAME: ${{ secrets.USERNAME }}
                    KEY: ${{ secrets.SSH_PRIVATE_KEY }}
                run: |
                    mkdir -p ~/.ssh
                    echo "$KEY" > ~/.ssh/id_rsa
                    chmod 600 ~/.ssh/id_rsa
                    scp -r hotel-management black@192.168.0.114:/opt/hotel-management/.next
                    ssh black@192.168.0.114 "cd /opt/hotel-management && npm install --production && pm2 restart all"
                ACTIONS_STEP_DEBUG: true
